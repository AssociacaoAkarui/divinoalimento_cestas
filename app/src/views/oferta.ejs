<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#E57021" />
    <link rel="shortcut icon" href="images/favicon.png" type="image/png" />
    <title>Divino Alimento - Nova Oferta</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/pages/oferta.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/js/services/api.service.js"></script>
    <script src="/js/services/oferta.service.js"></script>
    <script src="/js/utils/feedback.js"></script>
  </head>

  <body>
    <header class="header">
      <div class="header-content">
        <h1 class="header-title">üå± Divino Alimento - Ofertas</h1>

        <% if (usuarioAtivo && usuarioAtivo.perfil && usuarioAtivo.perfil.indexOf('admin') >= 0) { %>
          <div class="dropdown" id="userDropdown">
            <button class="dropdown-toggle" onclick="toggleDropdown()" aria-haspopup="true" aria-expanded="false">
              üë§ <%= usuarioOferta ? usuarioOferta.nome : 'Selecionar' %>
            </button>
            <div class="dropdown-menu" role="menu">
              <input class="search-input" type="text" id="searchUsuario" placeholder="Buscar fornecedor..." style="margin: 0.5rem; width: calc(100% - 1rem);">
              <% usuarios.forEach(usuario => { %>
                <a href="?usr=<%= usuario.id %>" class="dropdown-item" role="menuitem"><%= usuario.nome %></a>
              <% }) %>
            </div>
          </div>
        <% } %>
      </div>
    </header>

    <div class="container">
      <%
        const ofertaInicio = Date.parse(ciclo.ofertaInicio)
        const ofertaFim = Date.parse(ciclo.ofertaFim)
        const dataAtual = Date.now() - 10800000
        const tempoOfertaIniciado = ofertaInicio < dataAtual ? 1 : 0
        const tempoOfertaFinalizado = ofertaFim < dataAtual ? 1 : 0
        let haOferta = produtosOfertaDados.some(p => p.quantidade > 0)
        let posIndicador = 0
        if (tempoOfertaFinalizado) posIndicador = 3
        else if (haOferta) posIndicador = 2
        else if (tempoOfertaIniciado) posIndicador = 1
      %>

      <div class="card">
        <h2 style="font-size: 1.75rem; margin-bottom: 0.5rem;">Ol√°, <%= usuarioOferta ? usuarioOferta.nome : 'Fornecedor' %>! üëã</h2>
        <p style="color: var(--gray-600); font-size: 1.125rem; margin-bottom: 1.5rem;">Ciclo <strong><%= ciclo.nome %></strong></p>

        <div class="progress-steps" role="progressbar" aria-valuenow="<%= posIndicador %>" aria-valuemin="0" aria-valuemax="3">
          <div class="progress-line">
            <div class="progress-line-fill" style="width: <%= (posIndicador / 3) * 100 %>%"></div>
          </div>

          <div class="step <%= posIndicador >= 0 ? 'active' : '' %>">
            <div class="step-circle <%= posIndicador > 0 ? 'completed' : posIndicador === 0 ? 'active' : '' %>">
              <%= posIndicador > 0 ? '‚úì' : '1' %>
            </div>
            <span class="step-label">Per√≠odo Iniciado</span>
          </div>

          <div class="step <%= posIndicador >= 1 ? 'active' : '' %>">
            <div class="step-circle <%= posIndicador > 1 ? 'completed' : posIndicador === 1 ? 'active' : '' %>">
              <%= posIndicador > 1 ? '‚úì' : '2' %>
            </div>
            <span class="step-label">Sele√ß√£o Produtos</span>
          </div>

          <div class="step <%= posIndicador >= 2 ? 'active' : '' %>">
            <div class="step-circle <%= posIndicador > 2 ? 'completed' : posIndicador === 2 ? 'active' : '' %>">
              <%= posIndicador > 2 ? '‚úì' : '3' %>
            </div>
            <span class="step-label">Oferta Enviada</span>
          </div>

          <div class="step <%= posIndicador >= 3 ? 'active' : '' %>">
            <div class="step-circle <%= posIndicador === 3 ? 'active' : '' %>">
              4
            </div>
            <span class="step-label">Encerrado</span>
          </div>
        </div>

        <% if (posIndicador === 0) { %>
          <div class="alert alert-info" role="status">
            <span>‚ÑπÔ∏è</span>
            <span>Ofertas poder√£o ser enviadas a partir de <strong><%= ciclo.ofertaInicio.toISOString().substr(8,2) %>/<%= ciclo.ofertaInicio.toISOString().substr(5,2) %>/<%= ciclo.ofertaInicio.toISOString().substr(0,4) %> √†s <%= ciclo.ofertaInicio.toISOString().substr(11,5) %>h</strong></span>
          </div>
        <% } else if (posIndicador === 3) { %>
          <div class="alert alert-warning" role="status">
            <span>‚è∞</span>
            <span>Per√≠odo para ofertas encerrado</span>
          </div>
        <% } else { %>
          <div class="alert alert-success" role="status">
            <span>‚úÖ</span>
            <span>Ofertas podem ser enviadas at√© <strong><%= ciclo.ofertaFim.toISOString().substr(8,2) %>/<%= ciclo.ofertaFim.toISOString().substr(5,2) %>/<%= ciclo.ofertaFim.toISOString().substr(0,4) %> √†s <%= ciclo.ofertaFim.toISOString().substr(11,5) %>h</strong></span>
          </div>
        <% } %>
      </div>

      <% if (haOferta) { %>
        <div class="summary-card">
          <div class="summary-stat">
            <div>
              <div class="summary-number" id="totalOffered"><%= produtosOfertaDados.filter(p => p.quantidade > 0).length %></div>
              <div class="summary-label">Produtos Ofertados</div>
            </div>
          </div>

          <div class="offered-list" id="offeredList">
            <% produtosOfertaDados.forEach(produto => {
              if (produto.quantidade > 0) { %>
                <div class="offered-item">
                  <span class="offered-item-name"><%= produto.nome %> (<%= produto.medida %>)</span>
                  <span class="offered-item-qty"><%= produto.quantidade %></span>
                  <form method="POST" action="/ofertaapagarproduto" style="margin: 0;">
                    <input type="hidden" name="cicloId" value="<%= ciclo.id %>">
                    <input type="hidden" name="usuarioOfertaId" value="<%= usuarioOferta.id %>">
                    <button type="submit" name="ofertaproduto" value="<%= produto.id %>" class="remove-btn" title="Remover produto" aria-label="Remover <%= produto.nome %>">
                      ‚úï
                    </button>
                  </form>
                </div>
              <% }
            }) %>
          </div>
        </div>
      <% } else { %>
        <div class="alert alert-info">
          <span>ÔøΩÔøΩ</span>
          <span>Voc√™ ainda n√£o possui produtos ofertados neste ciclo</span>
        </div>
      <% } %>

      <% if (posIndicador >= 1 && posIndicador < 4) { %>
        <form id="form-ofertaProdutos" method="POST" action="/ofertasave">
          <input type="hidden" name="ofertaId" value="<%= oferta.id %>">
          <input type="hidden" name="cicloId" value="<%= ciclo.id %>">
          <input type="hidden" name="usuarioOfertaId" value="<%= usuarioOferta.id %>">

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üõí Selecione os Produtos</h3>
            </div>

            <div class="search-box">
              <span class="search-icon" aria-hidden="true">üîç</span>
              <input
                type="text"
                id="searchProduto"
                class="search-input"
                placeholder="Digite o nome do produto para filtrar..."
                aria-label="Buscar produtos"
              >
            </div>

            <%
              let todosProdutos = produtos || []
              let maisOfertados = todosProdutos.filter(p => p.origemProduto === 'maisOfertados')
              let restantes = todosProdutos.filter(p => !p.origemProduto || p.origemProduto === 'restantes')

              if (maisOfertados.length === 0 && restantes.length === 0) {
                restantes = todosProdutos
              }
            %>

            <% if (maisOfertados.length > 0) { %>
              <h4 class="section-title">‚≠ê Produtos Recentemente Ofertados</h4>
              <div class="product-grid">
                <% maisOfertados.forEach(produto => { %>
                  <div class="product-card" data-product-id="<%= produto.id %>">
                    <div class="product-name"><%= produto.nome %></div>
                    <% if (produto.categoria) { %>
                      <div class="product-category"><%= produto.categoria %></div>
                    <% } %>
                    <% if (produto.descricao) { %>
                      <div class="product-description"><%= produto.descricao %></div>
                    <% } %>
                    <div class="product-info">
                      <div class="product-price-info">
                        <div class="product-price">R$ <%= produto.valorReferencia.toFixed(2).replace('.', ',') %></div>
                        <div class="product-unit">por <%= produto.medida %></div>
                      </div>
                      <div class="quantity-control">
                        <button type="button" class="quantity-btn" onclick="decreaseQuantity(<%= produto.id %>)" aria-label="Diminuir quantidade">‚àí</button>
                        <input
                          type="number"
                          class="quantity-input"
                          id="quantidade<%= produto.id %>"
                          name="quantidade<%= produto.id %>"
                          value="<%= produto.quantidade %>"
                          min="0"
                          onchange="updateProductCard(<%= produto.id %>, this.value); updateTotalCount()"
                          aria-label="Quantidade de <%= produto.nome %>"
                        />
                        <button type="button" class="quantity-btn" onclick="increaseQuantity(<%= produto.id %>)" aria-label="Aumentar quantidade">+</button>
                      </div>
                    </div>
                  </div>
                <% }) %>
              </div>
              <hr class="section-divider">
            <% } %>

            <% if (restantes.length > 0) { %>
              <h4 class="section-title">üì¶ Demais Produtos</h4>
              <div class="product-grid">
                <% restantes.forEach(produto => { %>
                  <div class="product-card" data-product-id="<%= produto.id %>">
                    <div class="product-name"><%= produto.nome %></div>
                    <% if (produto.categoria) { %>
                      <div class="product-category"><%= produto.categoria %></div>
                    <% } %>
                    <% if (produto.descricao) { %>
                      <div class="product-description"><%= produto.descricao %></div>
                    <% } %>
                    <div class="product-info">
                      <div class="product-price-info">
                        <div class="product-price">R$ <%= produto.valorReferencia.toFixed(2).replace('.', ',') %></div>
                        <div class="product-unit">por <%= produto.medida %></div>
                      </div>
                      <div class="quantity-control">
                        <button type="button" class="quantity-btn" onclick="decreaseQuantity(<%= produto.id %>)" aria-label="Diminuir quantidade">‚àí</button>
                        <input
                          type="number"
                          class="quantity-input"
                          id="quantidade<%= produto.id %>"
                          name="quantidade<%= produto.id %>"
                          value="<%= produto.quantidade %>"
                          min="0"
                          onchange="updateProductCard(<%= produto.id %>, this.value); updateTotalCount()"
                          aria-label="Quantidade de <%= produto.nome %>"
                        />
                        <button type="button" class="quantity-btn" onclick="increaseQuantity(<%= produto.id %>)" aria-label="Aumentar quantidade">+</button>
                      </div>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } %>
          </div>
        </form>
      <% } %>
    </div>

    <% if (posIndicador >= 1 && posIndicador < 4) { %>
      <div class="bottom-bar">
        <div class="bottom-bar-content">
          <div class="total-info">
            <span>Total de produtos: </span>
            <span class="total-number" id="totalCount">0</span>
          </div>
          <button type="submit" form="form-ofertaProdutos" class="btn btn-primary btn-success" id="submitBtn">
            <span>üì§</span>
            <span>Enviar Oferta</span>
          </button>
        </div>
      </div>
    <% } %>

    <script>
      function replaceSpecialChars(str) {
        if (!str) return ''
        return str.toString()
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
      }

      const searchUsuario = document.getElementById('searchUsuario')
      if (searchUsuario) {
        searchUsuario.addEventListener('keyup', function() {
          const value = replaceSpecialChars(this.value)
          const items = document.querySelectorAll('.dropdown-item')
          items.forEach(item => {
            const text = replaceSpecialChars(item.textContent)
            item.style.display = text.includes(value) ? 'block' : 'none'
          })
        })
      }

      const searchProduto = document.getElementById('searchProduto')
      if (searchProduto) {
        searchProduto.addEventListener('keyup', function() {
          const value = replaceSpecialChars(this.value)
          const products = document.querySelectorAll('.product-card')
          products.forEach(product => {
            const text = replaceSpecialChars(product.textContent)
            product.style.display = text.includes(value) ? 'flex' : 'none'
          })
        })
      }

      function toggleDropdown() {
        const dropdown = document.getElementById('userDropdown')
        if (dropdown) {
          dropdown.classList.toggle('active')
        }
      }

      document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('userDropdown')
        if (dropdown && !dropdown.contains(e.target)) {
          dropdown.classList.remove('active')
        }
      })

      function updateTotalCount() {
        const inputs = document.querySelectorAll('.quantity-input')
        let total = 0
        inputs.forEach(input => {
          const value = parseInt(input.value) || 0
          if (value > 0) total++
        })
        const totalElement = document.getElementById('totalCount')
        if (totalElement) {
          totalElement.textContent = total
        }
      }

      function decreaseQuantity(productId) {
        const input = document.getElementById('quantidade' + productId)
        const currentValue = parseInt(input.value) || 0
        if (currentValue > 0) {
          input.value = currentValue - 1
          updateProductCard(productId, currentValue - 1)
          updateTotalCount()
        }
      }

      function increaseQuantity(productId) {
        const input = document.getElementById('quantidade' + productId)
        const currentValue = parseInt(input.value) || 0
        input.value = currentValue + 1
        updateProductCard(productId, currentValue + 1)
        updateTotalCount()
      }

      function updateProductCard(productId, quantity) {
        const card = document.querySelector(`[data-product-id="${productId}"]`)
        if (card) {
          if (quantity > 0) {
            card.classList.add('has-quantity')
          } else {
            card.classList.remove('has-quantity')
          }
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        updateTotalCount()

        const inputs = document.querySelectorAll('.quantity-input')
        inputs.forEach(input => {
          const productId = input.id.replace('quantidade', '')
          const value = parseInt(input.value) || 0
          updateProductCard(productId, value)
        })
      })

      <% if (loadAposSalvar == 1) { %>
        alert('‚úÖ Parab√©ns! Sua oferta foi enviada com sucesso.')
      <% } %>

      // AJAX - Busca em tempo real
      const searchInput = document.getElementById('searchProduto')
      let searchTimeout

      if (searchInput) {
        searchInput.addEventListener('input', function(e) {
          clearTimeout(searchTimeout)
          const termo = e.target.value.trim()

          searchTimeout = setTimeout(() => {
            filtrarProdutosLocal(termo)
          }, 300)
        })
      }

      function filtrarProdutosLocal(termo) {
        const cards = document.querySelectorAll('.product-card')
        const termoLower = termo.toLowerCase()

        cards.forEach(card => {
          const nome = card.querySelector('.product-name')?.textContent.toLowerCase() || ''
          const categoria = card.querySelector('.product-category')?.textContent.toLowerCase() || ''

          if (nome.includes(termoLower) || categoria.includes(termoLower) || termo === '') {
            card.style.display = 'block'
          } else {
            card.style.display = 'none'
          }
        })
      }

      // AJAX - Atualizar quantidade sem reload
      const quantityInputs = document.querySelectorAll('.quantity-input')
      let updateTimeout = {}

      quantityInputs.forEach(input => {
        input.addEventListener('change', async function() {
          const produtoId = this.id.replace('quantidade', '')
          const quantidade = parseInt(this.value) || 0

          await atualizarQuantidadeAjax(produtoId, quantidade)
        })
      })

      const incrementButtons = document.querySelectorAll('.quantity-btn[onclick*="changeQuantity"]')
      incrementButtons.forEach(btn => {
        btn.addEventListener('click', async function(e) {
          const inputId = this.getAttribute('onclick').match(/'([^']+)'/)[1]
          const input = document.getElementById(inputId)

          setTimeout(async () => {
            const produtoId = inputId.replace('quantidade', '')
            const quantidade = parseInt(input.value) || 0
            await atualizarQuantidadeAjax(produtoId, quantidade)
          }, 100)
        })
      })

      async function atualizarQuantidadeAjax(produtoId, quantidade) {
        try {
          const data = await OfertaService.atualizarQuantidade(
            produtoId,
            quantidade,
            <%= oferta.id %>
          )

          if (data.success) {
            updateProductCard(produtoId, quantidade)
            updateTotalCount()
            await atualizarPainelOfertados()
            Feedback.success('‚úÖ Quantidade atualizada!')
          } else {
            Feedback.error('‚ùå Erro ao atualizar quantidade')
          }
        } catch (error) {
          console.error('Erro ao atualizar quantidade:', error)
          Feedback.error('‚ùå Erro de conex√£o')
        }
      }

      async function atualizarPainelOfertados() {
        try {
          const data = await OfertaService.obterProdutosOferta(<%= oferta.id %>)

          if (data.success) {
            const produtosOfertados = data.produtos.filter(p => p.quantidade > 0)

            const totalOffered = document.getElementById('totalOffered')
            if (totalOffered) {
              totalOffered.textContent = produtosOfertados.length
            }

            const offeredList = document.getElementById('offeredList')
            if (offeredList) {
              offeredList.innerHTML = ''

              produtosOfertados.forEach(produto => {
                const itemDiv = document.createElement('div')
                itemDiv.className = 'offered-item'
                itemDiv.innerHTML = `
                  <span class="offered-item-name">${produto.nome} (${produto.medida})</span>
                  <span class="offered-item-qty">${produto.quantidade}</span>
                  <form method="POST" action="/ofertaapagarproduto" style="margin: 0;">
                    <input type="hidden" name="cicloId" value="<%= ciclo.id %>">
                    <input type="hidden" name="usuarioOfertaId" value="<%= usuarioOferta.id %>">
                    <button type="submit" name="ofertaproduto" value="${produto.id}" class="remove-btn" title="Remover produto" aria-label="Remover ${produto.nome}">
                      ‚úï
                    </button>
                  </form>
                `
                offeredList.appendChild(itemDiv)
              })
            }
          }
        } catch (error) {
          console.error('Erro ao atualizar painel de ofertados:', error)
        }
      }

    </script>
  </body>
</html>
