<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#43A047" />
    <link rel="shortcut icon" href="images/favicon.png" type="image/png" />
    <title>Divino Alimento - Pedidos Extras</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/pages/pedidoConsumidores.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/js/services/api.service.js"></script>
    <script src="/js/services/pedidoConsumidores.service.js"></script>
    <script src="/js/utils/feedback.js"></script>
  </head>

  <body>
    <header class="header">
      <div class="header-content">
        <h1 class="header-title">üõí Divino Alimento - Pedidos Extras</h1>

        <% if (usuarioAtivo && usuarioAtivo.perfil && usuarioAtivo.perfil.indexOf('admin') >= 0) { %>
          <div class="dropdown" id="userDropdown">
            <button class="dropdown-toggle" onclick="toggleDropdown()" aria-haspopup="true" aria-expanded="false">
              üë§ <%= usuarioConsumidor ? usuarioConsumidor.nome : 'Selecionar' %>
            </button>
            <div class="dropdown-menu" role="menu">
              <input class="search-input" type="text" id="searchUsuario" placeholder="Buscar consumidor..." style="margin: 0.5rem; width: calc(100% - 1rem);">
              <% usuarios.forEach(usuario => { %>
                <a href="?usr=<%= usuario.id %>" class="dropdown-item" role="menuitem"><%= usuario.nome %></a>
              <% }) %>
            </div>
          </div>
        <% } %>
      </div>
    </header>

    <div class="container">
      <%
        const itensAdicionaisFim = ciclo.itensAdicionaisFim ? new Date(ciclo.itensAdicionaisFim) : null
        const dataAtual = new Date()
        const periodoAberto = itensAdicionaisFim ? dataAtual < itensAdicionaisFim : false
        const pedidoFinalizado = statusPedido === 'finalizado'

        // Calcular posi√ß√£o do indicador
        let posIndicador = 0
        if (pedidoFinalizado) posIndicador = 3
        else if (produtosPedidos && produtosPedidos.length > 0) posIndicador = 2
        else if (periodoAberto) posIndicador = 1

        // Calcular totais do pedido
        let totalPedido = 0
        let taxaAdministracao = 0
        const taxaPorProduto = 0.5

        if (produtosPedidos && produtosPedidos.length > 0) {
          produtosPedidos.forEach(p => {
            totalPedido += p.quantidade * p.valorReferencia
            taxaAdministracao += p.quantidade * taxaPorProduto
          })
        }
      %>

      <div class="card">
        <h2 style="font-size: 1.75rem; margin-bottom: 0.5rem;">
          Ol√°, <%= usuarioConsumidor ? usuarioConsumidor.nome : 'Consumidor' %>! üëã
        </h2>
        <p style="color: var(--gray-600); font-size: 1.125rem; margin-bottom: 1.5rem;">
          Ciclo <strong><%= ciclo.nome %></strong>
        </p>

        <div class="progress-steps" role="progressbar" aria-valuenow="<%= posIndicador %>" aria-valuemin="0" aria-valuemax="3">
          <div class="progress-line">
            <div class="progress-line-fill" style="width: <%= (posIndicador / 3) * 100 %>%"></div>
          </div>

          <div class="step <%= posIndicador >= 0 ? 'active' : '' %>">
            <div class="step-circle <%= posIndicador > 0 ? 'completed' : posIndicador === 0 ? 'active' : '' %>">
              <%= posIndicador > 0 ? '‚úì' : '1' %>
            </div>
            <span class="step-label">Ciclo Ativo</span>
          </div>

          <div class="step <%= posIndicador >= 1 ? 'active' : '' %>">
            <div class="step-circle <%= posIndicador > 1 ? 'completed' : posIndicador === 1 ? 'active' : '' %>">
              <%= posIndicador > 1 ? '‚úì' : '2' %>
            </div>
            <span class="step-label">Sele√ß√£o Produtos</span>
          </div>

          <div class="step <%= posIndicador >= 2 ? 'active' : '' %>">
            <div class="step-circle <%= posIndicador > 2 ? 'completed' : posIndicador === 2 ? 'active' : '' %>">
              <%= posIndicador > 2 ? '‚úì' : '3' %>
            </div>
            <span class="step-label">Pedido Enviado</span>
          </div>

          <div class="step <%= posIndicador >= 3 ? 'active' : '' %>">
            <div class="step-circle <%= posIndicador === 3 ? 'active' : '' %>">
              4
            </div>
            <span class="step-label">Finalizado</span>
          </div>
        </div>

        <% if (!periodoAberto && !pedidoFinalizado) { %>
          <div class="alert alert-warning" role="status">
            <span>‚è∞</span>
            <span>Per√≠odo para pedidos extras encerrado</span>
          </div>
        <% } else if (pedidoFinalizado) { %>
          <div class="alert alert-info" role="status">
            <span>‚úÖ</span>
            <span>Seu pedido foi finalizado com sucesso!</span>
          </div>
        <% } else if (itensAdicionaisFim) { %>
          <div class="alert alert-success" role="status">
            <span>üõí</span>
            <span>Finalize seu pedido at√© <strong><%= itensAdicionaisFim.toISOString().substr(8,2) %>/<%= itensAdicionaisFim.toISOString().substr(5,2) %>/<%= itensAdicionaisFim.toISOString().substr(0,4) %> √†s <%= itensAdicionaisFim.toISOString().substr(11,5) %>h</strong></span>
          </div>
        <% } %>
      </div>

      <!-- Cesta da Semana -->
      <% if (ciclo.observacao) { %>
        <div class="cesta-card">
          <h3>üß∫ Cesta da Semana</h3>
          <p><%= ciclo.observacao %></p>
        </div>
      <% } %>

      <!-- Resumo do Pedido -->
      <% if (produtosPedidos && produtosPedidos.length > 0) { %>
        <div class="summary-card <%= pedidoFinalizado ? 'status-finalizado' : '' %>">
          <div class="summary-header">
            <div class="summary-stat">
              <div>
                <div class="summary-number" id="totalItems"><%= produtosPedidos.length %></div>
                <div class="summary-label">Itens no Pedido</div>
              </div>
            </div>
            <div class="summary-totals">
              <div class="summary-total-label">Total do Pedido</div>
              <div class="summary-total-value" id="totalValue">R$ <%= (totalPedido + taxaAdministracao).toFixed(2).replace('.', ',') %></div>
              <div class="summary-fee">Produtos: R$ <%= totalPedido.toFixed(2).replace('.', ',') %> + Taxa: R$ <%= taxaAdministracao.toFixed(2).replace('.', ',') %></div>
            </div>
          </div>

          <div class="ordered-list" id="orderedList">
            <% produtosPedidos.forEach(produto => { %>
              <div class="ordered-item" data-produto-id="<%= produto.produtoId %>">
                <span class="ordered-item-name"><%= produto.nome %></span>
                <span class="ordered-item-qty"><%= produto.quantidade %>x</span>
                <span class="ordered-item-price">R$ <%= (produto.quantidade * produto.valorReferencia).toFixed(2).replace('.', ',') %></span>
              </div>
            <% }) %>
          </div>

          <% if (!pedidoFinalizado) { %>
            <div class="status-message" style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.15); border-radius: var(--radius); text-align: center;">
              ‚ö†Ô∏è Pedido n√£o finalizado. Confirme abaixo para garantir seus produtos!
            </div>
          <% } %>
        </div>
      <% } else { %>
        <div class="alert alert-info">
          <span>üì¶</span>
          <span>Voc√™ ainda n√£o possui produtos no pedido. Selecione abaixo!</span>
        </div>
      <% } %>

      <!-- Formul√°rio de Sele√ß√£o de Produtos -->
      <% if (periodoAberto || (usuarioAtivo && usuarioAtivo.perfil && usuarioAtivo.perfil.indexOf('admin') >= 0)) { %>
        <form id="form-pedidoConsumidores" method="POST" action="/pedidoconsumidores">
          <input type="hidden" name="pedidoConsumidorId" value="<%= pedidoConsumidorId %>">
          <input type="hidden" name="cicloId" value="<%= ciclo.id %>">
          <input type="hidden" name="usuarioConsumidorId" value="<%= usuarioConsumidor.id %>">

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üì¶ Produtos Dispon√≠veis</h3>
            </div>

            <div class="search-box">
              <span class="search-icon" aria-hidden="true">üîç</span>
              <input
                type="text"
                id="searchProduto"
                class="search-input"
                placeholder="Digite o nome do produto para filtrar..."
                aria-label="Buscar produtos"
              >
            </div>

            <div class="product-grid" id="productGrid">
              <% produtosPedidosConsumidorDados.forEach(produto => {
                const nomeInput = 'quantidade' + produto.id
                const temEstoque = produto.quantidadeDisponivel > 0
              %>
                <div class="product-card <%= produto.quantidade > 0 ? 'has-quantity' : '' %> <%= !temEstoque ? 'out-of-stock' : '' %>"
                     data-product-id="<%= produto.id %>"
                     data-valor="<%= produto.valorReferencia %>">
                  <div class="product-name">
                    <%= produto.nome %>
                    <span class="product-measure">(<%= produto.medida %>)</span>
                  </div>

                  <div class="product-supplier">
                    üë®‚Äçüåæ <%= produto.fornecedores %>
                  </div>

                  <div class="product-availability">
                    <span class="availability-number"><%= produto.quantidadeDisponivel %></span>
                    <span><%= produto.quantidadeDisponivel === 1 ? 'item dispon√≠vel' : 'itens dispon√≠veis' %></span>
                  </div>

                  <div class="product-info">
                    <div class="product-price-info">
                      <div class="product-price">R$ <%= produto.valorReferencia.toFixed(2).replace('.', ',') %></div>
                      <div class="product-unit">por <%= produto.medida %></div>
                    </div>

                    <div class="quantity-control">
                      <button type="button"
                              class="quantity-btn"
                              onclick="decreaseQuantity(<%= produto.id %>)"
                              aria-label="Diminuir quantidade"
                              <%= !temEstoque || pedidoFinalizado ? 'disabled' : '' %>>‚àí</button>
                      <input
                        type="number"
                        class="quantity-input"
                        id="<%= nomeInput %>"
                        name="<%= nomeInput %>"
                        value="<%= produto.quantidade || 0 %>"
                        min="0"
                        max="<%= produto.quantidadeDisponivel %>"
                        onchange="handleQuantityChange(<%= produto.id %>, this.value, <%= produto.quantidadeDisponivel %>)"
                        aria-label="Quantidade de <%= produto.nome %>"
                        <%= !temEstoque || pedidoFinalizado ? 'disabled' : '' %>
                      />
                      <button type="button"
                              class="quantity-btn"
                              onclick="increaseQuantity(<%= produto.id %>, <%= produto.quantidadeDisponivel %>)"
                              aria-label="Aumentar quantidade"
                              <%= !temEstoque || pedidoFinalizado ? 'disabled' : '' %>>+</button>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>

          <!-- Bottom Bar -->
          <% if (!pedidoFinalizado) { %>
            <div class="bottom-bar">
              <div class="bottom-bar-content">
                <div class="total-info">
                  <span class="total-items"><span id="totalCount">0</span> produtos selecionados</span>
                  <span class="total-value">R$ <span id="totalGeral">0,00</span></span>
                </div>
                <button type="submit"
                        class="btn-confirm"
                        name="salvarPedido"
                        id="submitBtn">
                  <span>‚úÖ</span>
                  <span>Confirmar Pedido</span>
                </button>
              </div>
            </div>
          <% } %>
        </form>
      <% } %>
    </div>

    <script>
      // Constantes do pedido
      const TAXA_POR_ITEM = 0.5;
      const PEDIDO_FINALIZADO = <%= pedidoFinalizado ? 'true' : 'false' %>;

      // ============================================
      // FUN√á√ïES DE UTILIDADE
      // ============================================
      function replaceSpecialChars(str) {
        if (!str) return '';
        return str.toString()
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '');
      }

      function formatarValor(valor) {
        return valor.toFixed(2).replace('.', ',');
      }

      // ============================================
      // DROPDOWN DE USU√ÅRIOS
      // ============================================
      function toggleDropdown() {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown) {
          dropdown.classList.toggle('active');
        }
      }

      document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown && !dropdown.contains(e.target)) {
          dropdown.classList.remove('active');
        }
      });

      const searchUsuario = document.getElementById('searchUsuario');
      if (searchUsuario) {
        searchUsuario.addEventListener('keyup', function() {
          const value = replaceSpecialChars(this.value);
          const items = document.querySelectorAll('.dropdown-item');
          items.forEach(item => {
            const text = replaceSpecialChars(item.textContent);
            item.style.display = text.includes(value) ? 'block' : 'none';
          });
        });
      }

      // ============================================
      // BUSCA DE PRODUTOS
      // ============================================
      const searchProduto = document.getElementById('searchProduto');
      if (searchProduto) {
        searchProduto.addEventListener('keyup', function() {
          const value = replaceSpecialChars(this.value);
          const products = document.querySelectorAll('.product-card');
          products.forEach(product => {
            const text = replaceSpecialChars(product.textContent);
            product.style.display = text.includes(value) ? 'flex' : 'none';
          });
        });
      }

      // ============================================
      // CONTROLE DE QUANTIDADE
      // ============================================
      function decreaseQuantity(productId) {
        if (PEDIDO_FINALIZADO) return;

        const input = document.getElementById('quantidade' + productId);
        const currentValue = parseInt(input.value) || 0;
        if (currentValue > 0) {
          input.value = currentValue - 1;
          updateProductCard(productId, currentValue - 1);
          updateTotals();
        }
      }

      function increaseQuantity(productId, maxQuantidade) {
        if (PEDIDO_FINALIZADO) return;

        const input = document.getElementById('quantidade' + productId);
        const currentValue = parseInt(input.value) || 0;
        if (currentValue < maxQuantidade) {
          input.value = currentValue + 1;
          updateProductCard(productId, currentValue + 1);
          updateTotals();
        } else {
          Feedback.warning('‚ö†Ô∏è Quantidade m√°xima dispon√≠vel: ' + maxQuantidade);
        }
      }

      function handleQuantityChange(productId, value, maxQuantidade) {
        if (PEDIDO_FINALIZADO) return;

        let quantidade = parseInt(value) || 0;

        // Validar limites
        if (quantidade < 0) quantidade = 0;
        if (quantidade > maxQuantidade) {
          quantidade = maxQuantidade;
          Feedback.warning('‚ö†Ô∏è Quantidade m√°xima dispon√≠vel: ' + maxQuantidade);
        }

        const input = document.getElementById('quantidade' + productId);
        input.value = quantidade;

        updateProductCard(productId, quantidade);
        updateTotals();
      }

      function updateProductCard(productId, quantity) {
        const card = document.querySelector(`[data-product-id="${productId}"]`);
        if (card) {
          if (quantity > 0) {
            card.classList.add('has-quantity');
          } else {
            card.classList.remove('has-quantity');
          }
        }
      }

      // ============================================
      // C√ÅLCULO DE TOTAIS
      // ============================================
      function updateTotals() {
        const cards = document.querySelectorAll('.product-card');
        let totalProdutos = 0;
        let totalItens = 0;
        let countProdutos = 0;

        cards.forEach(card => {
          const productId = card.dataset.productId;
          const valor = parseFloat(card.dataset.valor) || 0;
          const input = document.getElementById('quantidade' + productId);
          const quantidade = parseInt(input?.value) || 0;

          if (quantidade > 0) {
            totalProdutos += quantidade * valor;
            totalItens += quantidade;
            countProdutos++;
          }
        });

        const taxaAdministrativa = totalItens * TAXA_POR_ITEM;
        const totalGeral = totalProdutos + taxaAdministrativa;

        // Atualizar elementos na tela
        const totalCountEl = document.getElementById('totalCount');
        const totalGeralEl = document.getElementById('totalGeral');

        if (totalCountEl) totalCountEl.textContent = countProdutos;
        if (totalGeralEl) totalGeralEl.textContent = formatarValor(totalGeral);
      }

      // ============================================
      // INICIALIZA√á√ÉO
      // ============================================
      document.addEventListener('DOMContentLoaded', function() {
        // Atualizar visual dos cards com quantidade
        const inputs = document.querySelectorAll('.quantity-input');
        inputs.forEach(input => {
          const productId = input.id.replace('quantidade', '');
          const value = parseInt(input.value) || 0;
          updateProductCard(productId, value);
        });

        // Calcular totais iniciais
        updateTotals();

        // Adicionar padding no body para o bottom bar
        const bottomBar = document.querySelector('.bottom-bar');
        if (bottomBar) {
          document.body.style.paddingBottom = '100px';
        }
      });
    </script>
  </body>
</html>
